<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Attention-Aware Video Player (Mediapipe)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f2f5;
      text-align: center;
      margin: 0;
      padding: 20px;
    }
    h1 {
      color: #1a1a1a;
    }
    video {
      border: 2px solid #333;
      border-radius: 8px;
      margin: 10px;
      max-width: 600px;
    }
    #status {
      font-size: 1.3em;
      margin-top: 15px;
      font-weight: bold;
      padding: 10px;
      border-radius: 8px;
      background: #e9ecef;
      display: inline-block;
    }
    .alert {
      background: #dc3545;
      color: #fff;
    }
  </style>

  <!-- âœ… Mediapipe FaceMesh -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
</head>
<body>
  <h1>ðŸŽ¥ Attention-Aware Video Player (Mediapipe)</h1>
  <video id="videoPlayer" controls autoplay muted loop src="assets/lesson.mp4"></video>
  <br>
  <video id="webcam" autoplay playsinline muted width="400" height="300"></video>
  <p id="status">STATUS: Initializing...</p>

  <script>
    const videoPlayer = document.getElementById("videoPlayer");
    const webcam = document.getElementById("webcam");
    const statusEl = document.getElementById("status");

    let eyeClosedStart = null;
    const EAR_THRESHOLD = 0.2;   // smaller = more sensitive
    const DROWSY_TIME = 2000;    // ms to pause

    function distance(p1, p2) {
      return Math.sqrt((p1.x - p2.x) ** 2 + (p1.y - p2.y) ** 2);
    }

    function calculateEAR(eye) {
      const vertical = distance(eye[1], eye[5]) + distance(eye[2], eye[4]);
      const horizontal = distance(eye[0], eye[3]);
      return vertical / (2.0 * horizontal);
    }

    function onResults(results) {
      if (!results.multiFaceLandmarks || results.multiFaceLandmarks.length === 0) {
        // No face â†’ pause video
        if (!videoPlayer.paused) videoPlayer.pause();
        statusEl.textContent = "STATUS: Face not detected ðŸ›‘";
        statusEl.classList.add("alert");
        return;
      }

      const keypoints = results.multiFaceLandmarks[0];

      // Left & right eyes (mediapipe landmark indices)
      const leftEyeIdx = [33, 160, 158, 133, 153, 144];
      const rightEyeIdx = [362, 385, 387, 263, 373, 380];

      const leftEAR = calculateEAR(leftEyeIdx.map(i => keypoints[i]));
      const rightEAR = calculateEAR(rightEyeIdx.map(i => keypoints[i]));
      const avgEAR = (leftEAR + rightEAR) / 2;

      if (avgEAR < EAR_THRESHOLD) {
        if (eyeClosedStart === null) eyeClosedStart = Date.now();

        if (Date.now() - eyeClosedStart > DROWSY_TIME) {
          if (!videoPlayer.paused) videoPlayer.pause();
          statusEl.textContent = "ðŸ˜´ Drowsy! Video Paused.";
          statusEl.classList.add("alert");
        } else {
          statusEl.textContent = "STATUS: Eyes closing...";
          statusEl.classList.remove("alert");
        }
      } else {
        eyeClosedStart = null;
        statusEl.textContent = "STATUS: Attentive âœ…";
        statusEl.classList.remove("alert");
        if (videoPlayer.paused) videoPlayer.play();
      }
    }

    async function init() {
      const faceMesh = new FaceMesh({
        locateFile: (file) =>
          `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`,
      });
      faceMesh.setOptions({
        maxNumFaces: 1,
        refineLandmarks: true,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5,
      });
      faceMesh.onResults(onResults);

      const camera = new Camera(webcam, {
        onFrame: async () => {
          await faceMesh.send({ image: webcam });
        },
        width: 400,
        height: 300,
      });
      camera.start();

      statusEl.textContent = "STATUS: Ready âœ…";
    }

    init();
  </script>
</body>
</html>